generator clientPublic {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")
  schemas   = ["gestion", "psychomot", "public"]
}

model User {
  id           String        @id @default(uuid()) @db.Uuid
  role         UserRole      @default(THERAPIST)
  createdAt    DateTime      @default(now())
  authAccounts AuthAccount[]
  profile      Profile?

  @@schema("public")
}

model AuthAccount {
  id                Int     @id @default(autoincrement())
  provider          String
  providerAccountId String
  email             String?
  accessToken       String?
  refreshToken      String?
  expiresAt         Int?
  userId            String  @db.Uuid
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@schema("public")
}

model Profile {
  id                 String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId             String      @unique @db.Uuid
  civilite           Civilite?
  nom                String?     @db.VarChar(100)
  nomUsage           String?     @db.VarChar(100)
  prenom             String?     @db.VarChar(100)
  email              String?     @db.VarChar(255)
  telephonePersoNum  String?     @db.VarChar(50)
  telephoneMobileNum String?     @db.VarChar(50)
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  bilantypes         BilanType[] @relation("AuthorBilanTypes")
  patients           Patient[]
  sections           Section[]   @relation("AuthorSections")
  user               User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profile")
  @@schema("public")
}

model Patient {
  id        String    @id @default(uuid())
  firstName String
  lastName  String
  dob       DateTime?
  notes     String?
  createdAt DateTime  @default(now())
  profileId String    @db.Uuid
  bilans    Bilan[]
  profile   Profile   @relation(fields: [profileId], references: [id])

  @@schema("psychomot")
}

model BilanType {
  id          String             @id @default(uuid())
  name        String
  description String?
  isPublic    Boolean            @default(false)
  authorId    String?            @db.Uuid
  createdAt   DateTime           @default(now())
  bilans      Bilan[]
  author      Profile?           @relation("AuthorBilanTypes", fields: [authorId], references: [id])
  sections    BilanTypeSection[]

  @@schema("psychomot")
}

model Section {
  id                String                 @id @default(uuid())
  title             String
  kind              SectionKind
  description       String?
  schema            Json?
  defaultContent    Json?
  isPublic          Boolean                @default(false)
  authorId          String?                @db.Uuid
  createdAt         DateTime               @default(now())
  instances         BilanSectionInstance[]
  bilanTypeSections BilanTypeSection[]
  author            Profile?               @relation("AuthorSections", fields: [authorId], references: [id])
  examples          SectionExample[]
  job               Job?

  @@schema("psychomot")
}

enum Job {
  PSYCHOMOTRICIEN
  ERGOTHERAPEUTE
  NEUROPSYCHOLOGUE

  @@schema("psychomot")
}

model BilanTypeSection {
  id          String    @id @default(uuid())
  bilanTypeId String
  sectionId   String
  sortOrder   Int
  settings    Json?
  bilanType   BilanType @relation(fields: [bilanTypeId], references: [id])
  section     Section   @relation(fields: [sectionId], references: [id])

  @@schema("psychomot")
}

model SectionExample {
  id        String  @id @default(uuid())
  sectionId String
  label     String?
  content   String
  section   Section @relation(fields: [sectionId], references: [id])

  @@schema("psychomot")
}

model Bilan {
  id              String                 @id @default(uuid())
  title           String?
  patientId       String?
  bilanTypeId     String?
  descriptionHtml String?
  date            DateTime               @default(now())
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  bilanType       BilanType?             @relation(fields: [bilanTypeId], references: [id])
  patient         Patient?               @relation(fields: [patientId], references: [id])
  sections        BilanSectionInstance[]

  @@schema("psychomot")
}

model BilanSectionInstance {
  id                String  @id @default(uuid())
  bilanId           String
  sectionId         String
  order             Int
  contentNotes      Json
  notesCreatedAt    DateTime @default(now())
  notesUpdatedAt    DateTime @updatedAt
  
  generatedContent  Json?
  generatedContentCreatedAt    DateTime? @default(now())
  generatedContentUpdatedAt    DateTime? @updatedAt
  
  status            BilanSectionStatus @default(DRAFT)
  bilan             Bilan   @relation(fields: [bilanId], references: [id])
  section           Section @relation(fields: [sectionId], references: [id])

  @@index([bilanId, order])
  @@schema("psychomot")
}

enum BilanSectionStatus {
  DRAFT
  GENERATED
  REFINED
  PUBLISHED

  @@schema("psychomot")
}

enum Civilite {
  M
  MME
  MLLE

  @@schema("public")
}

enum UserRole {
  THERAPIST

  @@schema("public")
}

enum SectionKind {
  anamnese
  tests_standards
  observations
  profil_sensoriel
  bilan_complet
  CUSTOM_FORM
  conclusion

  @@schema("psychomot")
}
